name: Daily Briefing Pipeline

on:
  # 매일 UTC 21:00 (KST 06:00) 실행
  schedule:
    - cron: "0 21 * * *"

  # 수동 실행 허용
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (skip AI API calls)"
        required: false
        default: "false"
        type: boolean

env:
  NODE_VERSION: "20"

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run news pipeline
        env:
          # Supabase 설정
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          # Anthropic API
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # Revalidation
          REVALIDATE_URL: ${{ secrets.REVALIDATE_URL }}
          REVALIDATION_SECRET: ${{ secrets.REVALIDATION_SECRET }}
          # Dry run 모드
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: pnpm pipeline

      - name: Notify on success
        if: success()
        run: |
          echo "::notice title=Pipeline Success::Daily briefing has been generated successfully!"
          echo "Pipeline completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Handle failure
        if: failure()
        run: |
          echo "::error title=Pipeline Failed::Daily briefing pipeline failed. Check the logs for details."
          exit 1

  # Revalidation 작업 (선택적)
  revalidate:
    needs: run-pipeline
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Trigger ISR revalidation
        if: ${{ secrets.REVALIDATE_URL != '' }}
        env:
          REVALIDATE_URL: ${{ secrets.REVALIDATE_URL }}
          REVALIDATION_SECRET: ${{ secrets.REVALIDATION_SECRET }}
        run: |
          if [ -n "$REVALIDATE_URL" ]; then
            curl -X POST "$REVALIDATE_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $REVALIDATION_SECRET" \
              -d '{"paths": ["/", "/archive"]}' \
              --fail --silent --show-error
            echo "Revalidation triggered successfully"
          else
            echo "Skipping revalidation - no URL configured"
          fi
